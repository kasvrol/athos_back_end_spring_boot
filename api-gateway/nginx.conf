worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # =================================================================
    # Definição dos Upstreams (grupos de servidores para cada microsserviço)
    # O NGINX usará os nomes dos serviços definidos no docker-compose.yml
    # para encontrar os containers na rede Docker.
    # =================================================================

    upstream ms-autenticacao {
        server ms-autenticacao:8080;
    }

    upstream ms-notificacao {
        server ms-notificacao:8080;
    }

    upstream ms-evento {
        server ms-evento:8080;
    }

    upstream ms-campeonato {
        server ms-campeonato:8080;
    }

    upstream ms-pagamento {
        server ms-pagamento:8080;
    }

    upstream ms-avaliacao {
        server ms-avaliacao:8080;
    }

    # Ainda não implementado
    # upstream ms-recomendacao {
    #    server ms-recomendacao:8000;
    #}


    # =================================================================
    # Configuração do Servidor Principal (API Gateway)
    # O servidor escuta na porta 80 e roteia as requisições.
    # =================================================================

    server {
        listen 80;
        server_name localhost;

        # Configurações de proxy padrão para passar os cabeçalhos corretos
        # para os serviços de backend.
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # =================================================================
        # Regras de Roteamento (Locations)
        # Cada location corresponde a um prefixo de API e aponta para
        # o upstream do microsserviço correspondente.
        # =================================================================

        # Rota para o serviço de Autenticação e Usuários
        location /api/auth/login {
            proxy_pass http://ms-autenticacao/api/auth/login;
        }

        location /api/auth/register {
            proxy_pass http://ms-autenticacao/api/auth/register;
        }

        location = /internal/auth {
                    internal;
                    proxy_pass http://ms-autenticacao/api/auth/validate;

                    # Limpa o corpo da requisição de validação para ser mais leve
                    proxy_pass_request_body off;
                    proxy_set_header Content-Length "";
                    proxy_set_header X-Original-URI $request_uri;

                    # Passa o cabeçalho Authorization da requisição original para o serviço de auth
                    proxy_set_header Authorization $http_authorization;
        }


        # Rota para o serviço de Perfil de Usuário
        location /api/perfil/ {
            auth_request /internal/auth;
            proxy_pass http://ms-autenticacao/api/perfil/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Rota para o serviço de Eventos
        location /api/eventos/ {
            auth_request /internal/auth;
            proxy_pass http://ms-evento/api/eventos/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Rota para o serviço de Campeonatos
        location /api/campeonatos/ {
            auth_request /internal/auth;
            proxy_pass http://ms-campeonato/api/campeonatos/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /api/equipes/ {
            auth_request /internal/auth;
            proxy_pass http://ms-campeonato/api/equipes/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Rota para o serviço de Pagamentos
        location /api/pagamentos/ {
            auth_request /internal/auth;
            proxy_pass http://ms-pagamento/api/pagamentos/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Rota para o serviço de Avaliações
        location /api/avaliacoes/ {
            auth_request /internal/auth;
            proxy_pass http://ms-avaliacao/api/avaliacoes/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Rota para o serviço de Notificações
        location /api/notificacoes/ {
            auth_request /internal/auth;
            proxy_pass http://ms-notificacao/api/notificacoes/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Rota para o serviço de Recomendações - ainda não implementado
        #location /api/recomendacoes/ {
        #    auth_request /internal/auth;
        #    proxy_pass http://ms-recomendacao/api/recomendacoes/;
        #    proxy_set_header Host $host;
        #    proxy_set_header X-Real-IP $remote_addr;
        #    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        #}
    }
}
