# Define o número de processos de trabalho. 'auto' é uma boa opção padrão.
worker_processes auto;

events {
    # Define o número máximo de conexões simultâneas por processo de trabalho.
    worker_connections 1024;
}

http {
    # =================================================================
    # Definição dos Upstreams (grupos de servidores para cada microsserviço)
    # O NGINX usará os nomes dos serviços definidos no docker-compose.yml
    # para encontrar os contêineres na rede Docker.
    # =================================================================

    upstream ms_autenticacao {
        server ms-autenticacao:8080;
    }

    upstream ms_notificacao {
        server ms-notificacao:8080;
    }

    upstream ms_evento {
        server ms-evento:8080;
    }

    upstream ms_campeonato {
        server ms-campeonato:8080;
    }

    upstream ms_pagamento {
        server ms-pagamento:8080;
    }

    upstream ms_avaliacao {
        server ms-avaliacao:8080;
    }

    upstream ms_recomendacao {
        # Lembre-se que o serviço Python está na porta 8000
        server ms-recomendacao:8000;
    }


    # =================================================================
    # Configuração do Servidor Principal (API Gateway)
    # O servidor escuta na porta 80 e roteia as requisições.
    # =================================================================

    server {
        listen 80;
        server_name localhost;

        # Configurações de proxy padrão para passar os cabeçalhos corretos
        # para os serviços de backend.
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # =================================================================
        # Regras de Roteamento (Locations)
        # Cada location corresponde a um prefixo de API e aponta para
        # o upstream do microsserviço correspondente.
        # =================================================================

        # Rota para o serviço de Autenticação e Usuários
        location /api/auth/ {
            proxy_pass http://ms_autenticacao/;
        }

        # Rota para o serviço de Perfil de Usuário
        location /api/perfil/ {
            proxy_pass http://ms_autenticacao/;
        }

        # Rota para o serviço de Eventos
        location /api/eventos/ {
            proxy_pass http://ms_evento/;
        }

        # Rota para o serviço de Campeonatos
        location /api/campeonatos/ {
            proxy_pass http://ms_campeonato/;
        }

        location /api/equipes/ {
            proxy_pass http://ms_campeonato/;
        }

        # Rota para o serviço de Pagamentos
        location /api/pagamentos/ {
            proxy_pass http://ms_pagamento/;
        }

        # Rota para o serviço de Avaliações
        location /api/avaliacoes/ {
            proxy_pass http://ms_avaliacao/;
        }

        # Rota para o serviço de Notificações
        location /api/notificacoes/ {
            proxy_pass http://ms_notificacao/;
        }

        # Rota para o serviço de Recomendações
        location /api/recomendacoes/ {
            proxy_pass http://ms_recomendacao/;
        }
    }
}