worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # =================================================================
    # Definição dos Upstreams (grupos de servidores para cada microsserviço)
    # O NGINX usará os nomes dos serviços definidos no docker-compose.yml
    # para encontrar os containers na rede Docker.
    # =================================================================

    upstream ms_autenticacao {
        server ms-autenticacao:8080;
    }

    upstream ms_notificacao {
        server ms-notificacao:8080;
    }

    upstream ms_evento {
        server ms-evento:8080;
    }

    upstream ms_campeonato {
        server ms-campeonato:8080;
    }

    upstream ms_pagamento {
        server ms-pagamento:8080;
    }

    upstream ms_avaliacao {
        server ms-avaliacao:8080;
    }

    upstream ms_recomendacao {
        server ms-recomendacao:8000;
    }


    # =================================================================
    # Configuração do Servidor Principal (API Gateway)
    # O servidor escuta na porta 80 e roteia as requisições.
    # =================================================================

    server {
        listen 80;
        server_name localhost;

        # Configurações de proxy padrão para passar os cabeçalhos corretos
        # para os serviços de backend.
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # =================================================================
        # Regras de Roteamento (Locations)
        # Cada location corresponde a um prefixo de API e aponta para
        # o upstream do microsserviço correspondente.
        # =================================================================

        # Rota para o serviço de Autenticação e Usuários
        location /api/auth/ {
            proxy_pass http://ms_autenticacao/;
        }

        location = /internal/auth {
                    internal;
                    proxy_pass http://ms_autenticacao/api/auth/validate;

                    # Limpa o corpo da requisição de validação para ser mais leve
                    proxy_pass_request_body off;
                    proxy_set_header Content-Length "";
                    proxy_set_header X-Original-URI $request_uri;

                    # Passa o cabeçalho Authorization da requisição original para o serviço de auth
                    proxy_set_header Authorization $http_authorization;
        }


        # Rota para o serviço de Perfil de Usuário
        location /api/perfil/ {
            auth_request /internal/auth;
            proxy_pass http://ms_autenticacao/;
        }

        # Rota para o serviço de Eventos
        location /api/eventos/ {
            auth_request /internal/auth;
            proxy_pass http://ms_evento/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Rota para o serviço de Campeonatos
        location /api/campeonatos/ {
            auth_request /internal/auth;
            proxy_pass http://ms_campeonato/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /api/equipes/ {
            auth_request /internal/auth;
            proxy_pass http://ms_campeonato/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Rota para o serviço de Pagamentos
        location /api/pagamentos/ {
            auth_request /internal/auth;
            proxy_pass http://ms_pagamento/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Rota para o serviço de Avaliações
        location /api/avaliacoes/ {
            auth_request /internal/auth;
            proxy_pass http://ms_avaliacao/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Rota para o serviço de Notificações
        location /api/notificacoes/ {
            auth_request /internal/auth;
            proxy_pass http://ms_notificacao/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Rota para o serviço de Recomendações
        location /api/recomendacoes/ {
            auth_request /internal/auth;
            proxy_pass http://ms_recomendacao/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}